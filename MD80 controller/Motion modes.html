
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Motion modes &#8212; MD80 x CANdle Manual</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="shortcut icon" href="../_static/logo32x32.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Homing" href="Homing.html" />
    <link rel="prev" title="Calibration" href="Calibration.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">MD80 x CANdle Manual</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    MD80 x CANdle Manual
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../QuickStartGuide.html">
   Quick Start Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Ecosystem.html">
   MD80 x CANdle Ecosystem overview
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="MD80.html">
   MD80 controller
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="Measurements.html">
     Measurements
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Safety%20limits.html">
     Safety limits
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Output%20encoder.html">
     Output Encoder
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Calibration.html">
     Calibration
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Motion modes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Homing.html">
     Homing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Config.html">
     Config
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Status%20codes.html">
     Status
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../CANdle.html">
   CANdle and CANdle HAT
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../CANdle/Principle.html">
     Principle of operation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../CANdle/Using%20CANdle.html">
     Using CANdle and CANdle HAT
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../CANdle/Latency.html">
     Latency
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Software.html">
   Software package
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Software%20package/MDTOOL.html">
     MDtool
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Software%20package/Candle%20C%2B%2B%20library.html">
     CANdle C++ library
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Software%20package/Candle%20Python%20library.html">
     CANdle Python library
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Software%20package/Candle%20ROS%20nodes.html">
     CANdle ROS/ROS2 nodes
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Software%20package/Quick%20startup%20guide%20ROS.html">
     Quick startup guide - ROS
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Software%20package/Quick%20startup%20guide%20ROS2.html">
     Quick start - ROS2
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../canProtocol.html">
   MD80 FDCAN protocol
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../CANopen.html">
   MD80 CANopen
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../OD.html">
     Object Dictionary
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../FAQ.html">
   Common problems and FAQ
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Downloads.html">
   Downloads
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/executablebooks/jupyter-book"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2FMD80 controller/Motion modes.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/MD80 controller/Motion modes.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Motion modes
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#velocity-pid">
     Velocity PID
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#position-pid">
     Position PID
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#impedance-pd">
     Impedance PD
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#velocity-profile">
   Velocity Profile
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#position-profile">
   Position Profile
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#controller-implementation">
     Controller implementation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#motion-controller-tuning">
   Motion controller tuning
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#velocity-pid-velocity-profile">
     Velocity PID / Velocity Profile
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#position-pid-position-profile">
     Position PID / Position Profile
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     Impedance PD
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#current-pi">
     Current PI
    </a>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Motion modes</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Motion modes
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#velocity-pid">
     Velocity PID
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#position-pid">
     Position PID
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#impedance-pd">
     Impedance PD
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#velocity-profile">
   Velocity Profile
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#position-profile">
   Position Profile
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#controller-implementation">
     Controller implementation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#motion-controller-tuning">
   Motion controller tuning
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#velocity-pid-velocity-profile">
     Velocity PID / Velocity Profile
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#position-pid-position-profile">
     Position PID / Position Profile
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     Impedance PD
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#current-pi">
     Current PI
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="motion-modes">
<span id="id1"></span><h1>Motion modes<a class="headerlink" href="#motion-modes" title="Permalink to this headline">#</a></h1>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>TL;DR: <a class="reference external" href="https://www.youtube.com/watch?v=XnD8sG22zro&amp;t=0s">MD80 x CANdle - motion modes</a></p>
</div>
<p>To control the motor shaft with the user’s command MD80 is equipped with multiple control loops. All controllers are based on a regular PID controller design with an anti-windup block. The saturator (anti-windup) is an additional module that acts as a limiter to the ‘I’ part of the controller, as in many systems, the error integration may grow to very large numbers, completely overwhelming ‘P’ and ‘D’ parts of the controller.</p>
<figure class="align-center">
<img alt="candle" class="no-scaled-link" src="../_images/limiters.png" />
</figure>
<section id="velocity-pid">
<h2>Velocity PID<a class="headerlink" href="#velocity-pid" title="Permalink to this headline">#</a></h2>
<p>Velocity PID controller calculates velocity error based on target velocity (set by user) and estimated velocity read from the encoder. Its output is a torque command for the internal current/torque controller. The parameters of the controller are:</p>
<ul class="simple">
<li><p>Velocity Target (in [rad/s])</p></li>
<li><p>kP (proportional gain)</p></li>
<li><p>kI (integral gain)</p></li>
<li><p>kD (derivative gain)</p></li>
<li><p>I windup (maximal output of an integral part in[Nm])</p></li>
</ul>
<figure class="align-center">
<img alt="candle" class="no-scaled-link" src="../_images/velocity_pid.png" />
</figure>
</section>
<section id="position-pid">
<h2>Position PID<a class="headerlink" href="#position-pid" title="Permalink to this headline">#</a></h2>
<p>Position PID mode is the most common controller mode used in industrial servo applications. In MD80, it is implemented as a cascaded PID controller. This means that the controller is working in two stages, firstly the position error is calculated, and it is then passed to the Position PID, which outputs the target velocity. This value is then passed as an input to the Velocity PID controller, which outputs commanded torque. This mode uses both Position PID and Velocity PID and thus needs the following parameters:</p>
<p>For Position PID:</p>
<ul class="simple">
<li><p>Position Target (in [rad])</p></li>
<li><p>kP (proportional gain)</p></li>
<li><p>kI (integral gain)</p></li>
<li><p>kD (derivative gain)</p></li>
<li><p>I windup (maximal output of an integral part in [rad/s])</p></li>
</ul>
<p>For Velocity PID:</p>
<ul class="simple">
<li><p>Velocity Target (in [rad/s])</p></li>
<li><p>kP (proportional gain)</p></li>
<li><p>kI (integral gain)</p></li>
<li><p>kD (derivative gain)</p></li>
<li><p>I windup (maximal output of an integral part in[Nm])</p></li>
</ul>
<p>To properly tune the controller, it is recommended to first tune the velocity controller (in velocity PID mode), and then the position PID. The controller can be described with a diagram:</p>
<figure class="align-center">
<img alt="candle" class="no-scaled-link" src="../_images/position_pid.png" />
</figure>
</section>
<section id="impedance-pd">
<h2>Impedance PD<a class="headerlink" href="#impedance-pd" title="Permalink to this headline">#</a></h2>
<p>Impedance Control mode is a popular choice for mobile or legged robots, as well as for any compliant mechanism. The main idea behind it is to mimic the behavior of a torsional spring with variable stiffness and damping. The parameters of the controller are:</p>
<ul class="simple">
<li><p>Position Target</p></li>
<li><p>Velocity Target</p></li>
<li><p>kP (position gain)</p></li>
<li><p>kD (velocity gain)</p></li>
<li><p>Torque Feed Forward (Torque FF)</p></li>
</ul>
<p>The torque output is proportional to the position error and velocity error and additionally supplemented with a torque command from the user. Here are some of the most common applications for this control mode:</p>
<ul class="simple">
<li><p><b>Spring-damper mechanism</b> - when velocity target is set to 0, impedance controllers kP gain acts as the virtual spring stiffness and kD as its damping coefficient.
Example use case: a variable suspension for a wheeled robot, where suspension stiffness can be regulated by kP, damping by kD, and height (clearance) by changing the target position;</p></li>
<li><p><b>High-frequency torque controller</b>, where its targets and gains can act as stabilizing agents to the torque command.
Example use case: In legged robots, force control can be achieved by advanced control algorithms, which usually operate at rates below 100 Hz. It is usually enough to stabilize the robot but too slow to avoid vibrations. Knowing desired robot’s joint positions, velocities, and torques, drives can be set to produce the proper torque and hold the position/velocity with small gains. This would compensate for any high-frequency oscillations (vibrations) that may occur, as the impedance controller works at 40kHz (much faster than &lt;100 Hz).</p></li>
<li><p><b>Raw torque controller</b> - when kP and kD are set to zero, the torque_ff command is equal to the output controller torque.</p></li>
</ul>
<p>The impedance controller is relatively simple and works according to the schematic below:</p>
<figure class="align-center">
<img alt="candle" class="no-scaled-link" src="../_images/impedance.png" />
</figure>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="velocity-profile">
<h1>Velocity Profile<a class="headerlink" href="#velocity-profile" title="Permalink to this headline">#</a></h1>
<p>The velocity profile motion mode uses trapezoidal velocity profiles to achieve smooth velocity changes with predefined acceleration and deceleration. The trajectory generator module interpolates between two velocity setpoints to achieve constant acceleration.</p>
<figure class="align-center">
<img alt="candle" class="no-scaled-link" src="../_images/velocity_profile_generator_CANdle.png" />
</figure>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="position-profile">
<h1>Position Profile<a class="headerlink" href="#position-profile" title="Permalink to this headline">#</a></h1>
<p>The position profile motion mode uses trapezoidal velocity profiles to achieve smooth position changes with predefined acceleration, deceleration, and velocity. The trajectory generator module interpolates between two position setpoints to achieve constant acceleration, and linearly changing velocity.</p>
<figure class="align-center">
<img alt="candle" class="no-scaled-link" src="../_images/position_profile_generator_CANdle.png" />
</figure>
<section id="controller-implementation">
<h2>Controller implementation<a class="headerlink" href="#controller-implementation" title="Permalink to this headline">#</a></h2>
<p>Controller implementation can be useful for simulating the actuators in virtual environments. Please find the PID and impedance C/C++ language implementations below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">float</span> <span class="n">mab_controller_performPid</span><span class="p">(</span><span class="n">PID_controller</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="nb">float</span> <span class="n">act_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">error_last</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">-</span> <span class="n">act_value</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">integrator</span> <span class="o">+=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">*</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dt</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">integrator</span> <span class="o">=</span> <span class="n">mab_commons_range</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">integrator</span><span class="p">,</span> <span class="o">-</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">integrator_windup</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">integrator_windup</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">de</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">error_last</span><span class="p">)</span><span class="o">/</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dt</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">=</span> <span class="n">mab_commons_range</span><span class="p">(</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">kp</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">ki</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">integrator</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">kd</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">de</span><span class="p">)</span> <span class="p">,</span> <span class="o">-</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">output_max</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">output_max</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">float</span> <span class="n">mab_controller_performImpedanceController</span><span class="p">(</span><span class="n">Impedance_controller</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="nb">float</span> <span class="n">position</span><span class="p">,</span> <span class="nb">float</span> <span class="n">velocity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">setTorque</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">kp</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">positionTarget</span> <span class="o">-</span> <span class="n">position</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">kd</span> <span class="o">*</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">velocityTarget</span> <span class="o">-</span> <span class="n">velocity</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">=</span> <span class="n">mab_commons_range</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">,</span> <span class="o">-</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">outputMax</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">outputMax</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="motion-controller-tuning">
<span id="id2"></span><h1>Motion controller tuning<a class="headerlink" href="#motion-controller-tuning" title="Permalink to this headline">#</a></h1>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>The best way to get started with tuning is to copy the <a class="reference external" href="https://2d033567-d193-42c8-9e42-4931131b206f.usrfiles.com/ugd/2d0335_4f52c3bdab9e4b1cbd2cec68e48b7e14.pdf">default gains</a> and tweak them. You can treat this section as our recommendation for tuning the controllers, but <a class="reference external" href="https://www.motioncontroltips.com/how-are-servo-system-velocity-control-loops-tuned/">online articles</a> can be useful as well</p>
</div>
<p>The first step to correctly set up the gains is to start with our <a class="reference external" href="https://2d033567-d193-42c8-9e42-4931131b206f.usrfiles.com/ugd/2d0335_4f52c3bdab9e4b1cbd2cec68e48b7e14.pdf">default gains</a>. There are three sets of default gains that are set on each motor power up and thus they allow for restoring the actuator to a default state in case some gains were set incorrectly by the user. These gains are also a great starting point for user modifications when the actuator has to be used in a specific application requiring high positioning accuracy or very dynamic movements.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Default gains are set to work with CANdle examples. This way they can be assumed to be universal but it does not have to always be the case</p>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>When something does go wrong during the tuning process just power-cycle the actuator - the default gains will be restored.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Always keep your safety limits low when experimenting with gains. Gains not suitable for your system may cause oscillations and unstable operation of the MD80-based actuators</p>
</div>
<section id="velocity-pid-velocity-profile">
<h2>Velocity PID / Velocity Profile<a class="headerlink" href="#velocity-pid-velocity-profile" title="Permalink to this headline">#</a></h2>
<ol class="simple">
<li><p>Start by slowly increasing kp gain of the controller keeping ki kd and iWindup set to zero</p></li>
<li><p>increase set iWindup to 1.0 and try increasing ki to see if it helps to reach the setpoint velocity</p></li>
<li><p>Generally try to avoid using kd</p></li>
</ol>
</section>
<section id="position-pid-position-profile">
<h2>Position PID / Position Profile<a class="headerlink" href="#position-pid-position-profile" title="Permalink to this headline">#</a></h2>
<ol class="simple">
<li><p>Tune the Velocity PID first - make sure in Velocity PID mode the actuator is able to follow the setpoints</p></li>
<li><p>Start by slowly increasing kp gain of the position controller keeping ki kd and iWindup set to zero</p></li>
<li><p>Increase set iWindup to 1.0 and try increasing ki to see if it helps to reach the setpoint velocity</p></li>
<li><p>Generally try to avoid using kd</p></li>
</ol>
</section>
<section id="id3">
<h2>Impedance PD<a class="headerlink" href="#id3" title="Permalink to this headline">#</a></h2>
<ol class="simple">
<li><p>Increase kp to the point you’re satisfied with the stiffnes of the output shaft (the spring coefficient)</p></li>
<li><p>Increase kd to the point youre satified with the damping of the output shaft (the damping coeficient)</p></li>
<li><p>Avoid setting kd too high - it may cause severe vibrations.</p></li>
</ol>
</section>
<section id="current-pi">
<h2>Current PI<a class="headerlink" href="#current-pi" title="Permalink to this headline">#</a></h2>
<p>Current/torque PI is the lowest-level controller. Its gains are not directly user-configurable, however, they can be modified using the bandwidth parameter. Please see the calibration section for more insight on the topic.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./MD80 controller"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="Calibration.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Calibration</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="Homing.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Homing</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By MAB Robotics<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>